name: Xlance AI Agent Runner

on:
  workflow_dispatch:
    inputs:
      task:
        description: "Agent task to run"
        required: true
        default: "redesign_find_work"
        type: choice
        options:
          - redesign_find_work
          - design_spec_find_work
          - firebase_review_rules
          - run_frontend_checks
          - asset_suggestions_find_work
          - refactor_file
      target_file:
        description: "File path for refactor_file (optional)"
        required: false
  issue_comment:
    types: [created]

jobs:
  run-agent:
    if: github.event_name == 'workflow_dispatch' ||
        (github.event_name == 'issue_comment' &&
         contains(github.event.comment.body, '/ai-agent'))
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install langgraph langchain groq python-dotenv

      - name: Set environment
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          echo "GROQ_API_KEY configured."

      - name: Run agent (manual dispatch)
        if: github.event_name == 'workflow_dispatch'
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          python -m ai_agents.run_task --task "${{ inputs.task }}" \
            $([ "${{ inputs.task }}" = "refactor_file" ] && echo "--file '${{ inputs.target_file }}'" )

      - name: Run agent from issue comment
        if: github.event_name == 'issue_comment'
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          # Very simple parser: /ai-agent redesign_find_work
          CMD=$(echo "${{ github.event.comment.body }}" | sed -n 's/.*\/ai-agent[[:space:]]\+//p' | head -n1)
          echo "Command: $CMD"
          python -m ai_agents.run_task --task "$CMD"
